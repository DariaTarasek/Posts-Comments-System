# Posts and Comments System
Cистема для добавления и чтения постов и комментариев на Golang с использованием GraphQL

## О проекте
### Характеристики системы постов:
- Можно просмотреть список постов.
- Можно просмотреть пост и комментарии под ним.
- Автор поста может запретить оставление комментариев к посту.

### Характеристики системы комментариев к постам: 
- Комментарии организованы иерархически, позволяя вложенность без ограничений.
- Длина текста комментария ограничена до 2000 символов.
- Система пагинации для получения списка комментариев.
- Можно подписаться на определенный пост, чтобы получать уведомления о новых комментариях асинхронно - без необходимости повторного запроса.

## Архитектура
Проект построен по принципам многоуровневой архитектуры, содержащей следующие слои:
- Слой API Gateway - взаимодействие клиентской части приложения с серверной: обработка запросов и подписок, реализация резолверов.
- Слой бизнес-логики - валидация данных, применение бизнес-правил.
- Слой хранилища - реализация интерфейсов хранения для PostgreSQL и in-memory.
  
Также отдельным слоем реализован механизм подписок на уведомления о новых комментариях к посту.

## Стек технологий
- Язык: Go 1.25
- Хранилище: PostgreSQL или in-memory
- GraphQL: gqlgen
- Контейнеризация: Docker
- Подписки: GraphQL Subscriptions
- Тестирование: testing, testify, mockery

## Хранилище
Хранение данных может быть как в памяти, так и в PostgreSQL. 
Выбор типа хранилища определяется при запуске сервиса. 

По умолчанию выбрано хранилище PostgreSQL.

## Запуск проекта
### Запуск при помощи Docker
При запуске необходимо указать тип хранилища, который будет использоваться.

Тип определяется переменной окружения **STORAGE_TYPE**.

STORAGE_TYPE может быть "postgres" или "memory"

Если не указать STORAGE_TYPE при запуске - система будет запущена с PostgreSQL.

#### Windows
Для in-memory хранилища:
```
docker compose run -e STORAGE_TYPE=memory --service-ports app
```
Для PostgreSQL хранилища:
```
docker compose run -e STORAGE_TYPE=postgres --service-ports app
```

### Linux
Для in-memory хранилища:
```
docker compose run --service-ports --env STORAGE_TYPE=memory app
```
Для PostgreSQL хранилища:
```
docker compose run --service-ports --env STORAGE_TYPE=postgres app
```

## Тестирование
Запуск тестов:
```
docker compose run app_test
```

## Использование API
После запуска сервера GraphQL Playground доступен по адресу: http://localhost:8080 

Эндпоинт для запросов: http://localhost:8080/graphql  

GraphQL-схема расположена в /internal/graphql/schema.graphqls

### Примеры запросов
Создание поста
```
mutation createPost {
  createPost(
    title: "Название"
    content: "Содержимое поста"
    author: "Автор"
    areCommentsAllowed: true
  ) {
    id
    title
    author
    createdAt
  }
}
```

Получение списка постов
```
query GetPosts {
  posts {
    id
    title
    author
    content
    createdAt
    areCommentsAllowed
  }
}
```

Создание комментария
```
mutation CreateComment {
  createComment(postId: "1", author: "Даша", content: "Корневой комментарий") {
    id
    postId
    parentCommentId
    author
    content
    createdAt
  }
}
```

Получение поста и корневых комментариев к нему
```
query GetPostByID {
  post(id: "1") {
    id
    title
    content
    author
    areCommentsAllowed
    createdAt
    comments(limit: 5, offset: 0) {
      totalPages
      comments {
        id
        author
        content
        createdAt
      }
    }
  }
}
```

Создание ответа на комментарий
```
mutation createReply {
  createComment(
    postId: "1"
    parentId: "1"
    author: "Анна"
    content: "Ответ на комментарий 1"
  ) {
    id
    postId
    parentCommentId
    path
    author
    content
    createdAt
  }
}
```

Получение ветки ответов к комментарию
```
query getReplies {
  replies(id: "1") {
    id
    postId
    parentCommentId
    path
    author
    content
    createdAt
  }
}
```

Подписка на новые комментарии
```
subscription newSubscription {
  newComment(postID: 1) {
    id
    content
    author
  }
}
```
При добавлении нового комментария к посту с id = 1 событие отобразится сразу в окне подписки в реальном времени. 

Подписку запустить в одном окне, опубликовать новый пост - в другом. В первом окне появится новый комментарий

## Принятые инженерные решения
### Решение N+1 проблемы
В системе реализована следующая логика, соответствующая требованиям:
#### Просмотр постов
- Можно просмотреть список всех постов (без комментариев) - 1 запрос.

#### Просмотр комментариев
- Можно просмотреть конкретный пост и комментарии к нему. - 1 запрос на пост, 1 запрос на комментарии
- По запросу поста и комментариев подгружаются только комментарии верхнего уровня (корневые) с пагинацией limit/offset. 
- По запросу подгружаются ответы на корневой комментарий - полная ветка вложенных комментариев. - 1 запрос

Архитектура проекта спроектирована так, чтобы минимизировать количество запросов к хранилищу. Потенциальные N+1 проблемы решены 
путем разделения логики по уровням и "ленивой" подгрузке данных.

## Работа с вложенными комментариями
### PostgreSQL
Для хранения комментариев используется тип ltree, позволяющий эффективно работать с иерархическими деревьями произвольной глубины.
Каждому комментарию при создании присваивается путь, отражающий его положение в дереве:

1     - корневой комментарий  
1.2   - ответ на комментарий 1  
1.2.3 - ответ на комментарий 1.2

Также создан GIST индекс на путь для повышения производительности поиска вложенных комментариев.
### In-memory
Для хранения иерархии в памяти используется:

map[postID][]commentID - хранит id корневых комментариев к посту.

map[parentID][]commentID - хранит id ответов на комментарий.

map[id]Comment - хранит сами комментарии

Получение ветки ответов выполняется итеративно через стек, чтобы избежать рекурсии и не перегружать память при глубокой вложенности комментариев.

## Порядок вывода постов и комментариев
Посты выводятся в порядке от новых к старым по дате создания.

Комментарии выводятся в виде плоского списка от старых к новым внутри своего уровня вложенности. 

Сначала выводится всю ветку ответов на корневой комментарий, например: 1, 1.2, 1.2.3.

После идут ответы на ответы, например: 1.2.4, 1.5

Схематично:


<img width="153" height="150" alt="image" src="https://github.com/user-attachments/assets/54ac21ca-b6f1-4494-907a-fbfce02c5668" />


## Механизм подписок
Система поддерживает GraphQL Subscriptions, чтобы клиенты могли получать уведомления о новых комментариях к посту в реальном времени.
### In-memory реализация
Подписки хранятся в виде map[int][]chan *Comment, ключом является id поста, значением - слайс каналов типа комментария.

При появлении нового комментария к посту он отправляется во все каналы подписчиков.

### PostgreSQL реализация
Используется механизм LISTEN/NOTIFY PostgreSQL.

Для каждого поста создаётся канал вида post_postID.

Когда добавляется новый комментарий, выполняется NOTIFY post_postID с отправкой комментария.

Подписчики, слушающие канал поста, получают комментарий.

## Автор
Тарасова Дарья,

tg: @tarasek,

tarasova.alien@yandex.ru

